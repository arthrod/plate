--- mammoth_before_refactoring/lib/docx/docx-reader.js	2026-02-19 23:58:28
+++ ./lib/docx/docx-reader.ts	2026-02-19 22:23:40
@@ -1,22 +1,22 @@
 exports.read = read;
 exports._findPartPaths = findPartPaths;
 
-var promises = require('../promises');
-var documents = require('../documents');
-var Result = require('../results').Result;
-var zipfile = require('../zipfile');
+var promises = require('../promises.ts');
+var documents = require('../documents.ts');
+var Result = require('../results.ts').Result;
+var zipfile = require('../zipfile.ts');
 
-var readXmlFromZipFile = require('./office-xml-reader').readXmlFromZipFile;
-var createBodyReader = require('./body-reader').createBodyReader;
-var DocumentXmlReader = require('./document-xml-reader').DocumentXmlReader;
-var relationshipsReader = require('./relationships-reader');
-var contentTypesReader = require('./content-types-reader');
-var numberingXml = require('./numbering-xml');
-var stylesReader = require('./styles-reader');
-var notesReader = require('./notes-reader');
-var commentsReader = require('./comments-reader');
-var commentsExtendedReader = require('./comments-extended-reader');
-var Files = require('./files').Files;
+var readXmlFromZipFile = require('./office-xml-reader.ts').readXmlFromZipFile;
+var createBodyReader = require('./body-reader.ts').createBodyReader;
+var DocumentXmlReader = require('./document-xml-reader.ts').DocumentXmlReader;
+var relationshipsReader = require('./relationships-reader.ts');
+var contentTypesReader = require('./content-types-reader.ts');
+var numberingXml = require('./numbering-xml.ts');
+var stylesReader = require('./styles-reader.ts');
+var notesReader = require('./notes-reader.ts');
+var commentsReader = require('./comments-reader.ts');
+var commentsExtendedReader = require('./comments-extended-reader.ts');
+var Files = require('./files.ts').Files;
 
 function read(docxFile, input, options) {
   input = input || {};
@@ -27,139 +27,144 @@
     relativeToFile: input.path,
   });
 
-  return promises
-    .props({
-      contentTypes: readContentTypesFromZipFile(docxFile),
-      partPaths: findPartPaths(docxFile),
+  var initial = promises.props({
+    contentTypes: readContentTypesFromZipFile(docxFile),
+    partPaths: findPartPaths(docxFile),
+    docxFile,
+    files,
+  });
+
+  var withStyles = promises.also(initial, (result) => ({
+    styles: readStylesFromZipFile(docxFile, result.partPaths.styles),
+  }));
+
+  var withNumbering = promises.also(withStyles, (result) => ({
+    numbering: readNumberingFromZipFile(
       docxFile,
-      files,
-    })
-    .also((result) => ({
-      styles: readStylesFromZipFile(docxFile, result.partPaths.styles),
-    }))
-    .also((result) => ({
-      numbering: readNumberingFromZipFile(
-        docxFile,
-        result.partPaths.numbering,
-        result.styles
-      ),
-    }))
-    .also((result) => ({
-      commentsExtended: readXmlFromZipFile(
-        result.docxFile,
-        result.partPaths.commentsExtended
-      ).then((xml) => {
-        if (xml) {
-          return commentsExtendedReader.createCommentsExtendedReader()(xml);
+      result.partPaths.numbering,
+      result.styles
+    ),
+  }));
+
+  var withCommentsExtended = promises.also(withNumbering, (result) => ({
+    commentsExtended: readXmlFromZipFile(
+      result.docxFile,
+      result.partPaths.commentsExtended
+    ).then((xml) => {
+      if (xml) {
+        return commentsExtendedReader.createCommentsExtendedReader()(xml);
+      }
+      return new Result({});
+    }),
+    // Read commentsIds.xml (paraId → durableId) and
+    // commentsExtensible.xml (durableId → dateUtc) to build
+    // a paraId → dateUtc map for correcting Word's fake-Z dates.
+    dateUtcMap: promises
+      .props({
+        idsXml: readXmlFromZipFile(
+          result.docxFile,
+          result.partPaths.commentsIds || 'word/commentsIds.xml'
+        ),
+        extXml: readXmlFromZipFile(
+          result.docxFile,
+          result.partPaths.commentsExtensible || 'word/commentsExtensible.xml'
+        ),
+      })
+      .then((r) => {
+        var paraIdToDurable = {};
+        if (r.idsXml) {
+          r.idsXml.children.forEach((child) => {
+            if (child.name === 'w16cid:commentId') {
+              var pid = child.attributes['w16cid:paraId'];
+              var did = child.attributes['w16cid:durableId'];
+              if (pid && did) paraIdToDurable[pid] = did;
+            }
+          });
         }
-        return new Result({});
-      }),
-      // Read commentsIds.xml (paraId → durableId) and
-      // commentsExtensible.xml (durableId → dateUtc) to build
-      // a paraId → dateUtc map for correcting Word's fake-Z dates.
-      dateUtcMap: promises
-        .props({
-          idsXml: readXmlFromZipFile(
-            result.docxFile,
-            result.partPaths.commentsIds || 'word/commentsIds.xml'
-          ),
-          extXml: readXmlFromZipFile(
-            result.docxFile,
-            result.partPaths.commentsExtensible || 'word/commentsExtensible.xml'
-          ),
-        })
-        .then((r) => {
-          var paraIdToDurable = {};
-          if (r.idsXml) {
-            r.idsXml.children.forEach((child) => {
-              if (child.name === 'w16cid:commentId') {
-                var pid = child.attributes['w16cid:paraId'];
-                var did = child.attributes['w16cid:durableId'];
-                if (pid && did) paraIdToDurable[pid] = did;
-              }
-            });
-          }
-          var durableToDateUtc = {};
-          if (r.extXml) {
-            r.extXml.children.forEach((child) => {
-              if (child.name === 'w16cex:commentExtensible') {
-                var did = child.attributes['w16cex:durableId'];
-                var utc = child.attributes['w16cex:dateUtc'];
-                if (did && utc) durableToDateUtc[did] = utc;
-              }
-            });
-          }
-          // Combine: paraId → durableId → dateUtc
-          var map = {};
-          Object.keys(paraIdToDurable).forEach((pid) => {
-            var did = paraIdToDurable[pid];
-            if (durableToDateUtc[did]) {
-              map[pid] = durableToDateUtc[did];
+        var durableToDateUtc = {};
+        if (r.extXml) {
+          r.extXml.children.forEach((child) => {
+            if (child.name === 'w16cex:commentExtensible') {
+              var did = child.attributes['w16cex:durableId'];
+              var utc = child.attributes['w16cex:dateUtc'];
+              if (did && utc) durableToDateUtc[did] = utc;
             }
           });
-          return new Result(map);
-        }),
-    }))
-    .also((result) => ({
-      footnotes: readXmlFileWithBody(
-        result.partPaths.footnotes,
-        result,
-        (bodyReader, xml) => {
-          if (xml) {
-            return notesReader.createFootnotesReader(bodyReader)(xml);
-          }
-          return new Result([]);
         }
-      ),
-      endnotes: readXmlFileWithBody(
-        result.partPaths.endnotes,
-        result,
-        (bodyReader, xml) => {
-          if (xml) {
-            return notesReader.createEndnotesReader(bodyReader)(xml);
+        // Combine: paraId → durableId → dateUtc
+        var map = {};
+        Object.keys(paraIdToDurable).forEach((pid) => {
+          var did = paraIdToDurable[pid];
+          if (durableToDateUtc[did]) {
+            map[pid] = durableToDateUtc[did];
           }
-          return new Result([]);
+        });
+        return new Result(map);
+      }),
+  }));
+
+  var withBodyParts = promises.also(withCommentsExtended, (result) => ({
+    footnotes: readXmlFileWithBody(
+      result.partPaths.footnotes,
+      result,
+      (bodyReader, xml) => {
+        if (xml) {
+          return notesReader.createFootnotesReader(bodyReader)(xml);
         }
-      ),
-      comments: readXmlFileWithBody(
-        result.partPaths.comments,
-        result,
-        (bodyReader, xml) => {
-          if (xml) {
-            return commentsReader.createCommentsReader(
-              bodyReader,
-              result.commentsExtended.value || {},
-              result.dateUtcMap.value || {}
-            )(xml);
-          }
-          return new Result([]);
+        return new Result([]);
+      }
+    ),
+    endnotes: readXmlFileWithBody(
+      result.partPaths.endnotes,
+      result,
+      (bodyReader, xml) => {
+        if (xml) {
+          return notesReader.createEndnotesReader(bodyReader)(xml);
         }
-      ),
-    }))
-    .also((result) => ({
-      notes: result.footnotes.flatMap((footnotes) =>
-        result.endnotes.map(
-          (endnotes) => new documents.Notes(footnotes.concat(endnotes))
-        )
-      ),
-    }))
-    .then((result) =>
-      readXmlFileWithBody(
-        result.partPaths.mainDocument,
-        result,
-        (bodyReader, xml) =>
-          result.notes.flatMap((notes) =>
-            result.comments.flatMap((comments) => {
-              var reader = new DocumentXmlReader({
-                bodyReader,
-                notes,
-                comments,
-              });
-              return reader.convertXmlToDocument(xml);
-            })
-          )
+        return new Result([]);
+      }
+    ),
+    comments: readXmlFileWithBody(
+      result.partPaths.comments,
+      result,
+      (bodyReader, xml) => {
+        if (xml) {
+          return commentsReader.createCommentsReader(
+            bodyReader,
+            result.commentsExtended.value || {},
+            result.dateUtcMap.value || {}
+          )(xml);
+        }
+        return new Result([]);
+      }
+    ),
+  }));
+
+  var withCombinedNotes = promises.also(withBodyParts, (result) => ({
+    notes: result.footnotes.flatMap((footnotes) =>
+      result.endnotes.map(
+        (endnotes) => new documents.Notes(footnotes.concat(endnotes))
       )
-    );
+    ),
+  }));
+
+  return withCombinedNotes.then((result) =>
+    readXmlFileWithBody(
+      result.partPaths.mainDocument,
+      result,
+      (bodyReader, xml) =>
+        result.notes.flatMap((notes) =>
+          result.comments.flatMap((comments) => {
+            var reader = new DocumentXmlReader({
+              bodyReader,
+              notes,
+              comments,
+            });
+            return reader.convertXmlToDocument(xml);
+          })
+        )
+    )
+  );
 }
 
 function findPartPaths(docxFile) {
