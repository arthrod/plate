"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[46639],{46639:(e,t,n)=>{n.d(t,{DQ:()=>W,EF:()=>ef,FV:()=>K,Fi:()=>el,HM:()=>q,Sv:()=>F,V:()=>R,WB:()=>Z,hC:()=>I,of:()=>N,qv:()=>C});var l=n(99019),i=n(5147),r=n(15457),o=n(69954),s=n(99680),a=n(50250),c=n(14796),u=n(48674),d=n(81993),g=n(50357),h=n(2498),p=n(42697),f=n(87010),m=n(45806),v=n(91579),y=n(28268),k=n(5125),x=n(30589),b=n(54097),_=n(13526),S=n(7620),O=n(60423);function A(){let e=(0,o._)(["$$"],["\\$\\$"]);return A=function(){return e},e}let N=(0,y.HS)(a.n),F=(e,t)=>{let n,{blockId:l,content:i}=t,r=(0,m.$r)(e,i),o=[];if(r.forEach((t,i)=>{let r;if(0===i)r=n=e.api.node({id:l,at:[]});else{if(!n)return;let[t,l]=n,o=[l[0]+i];r=e.api.node(o)}if(!r)return;let s=function(e){let{block:t,findText:n}=e,[l,i]=t,r=[],o="";for(let[e,t]of c.lZ.texts(l)){let n=o.length,l=[...i,...t];r.push({offset:n,path:l,text:e.text}),o+=e.text}if(!o)return null;let s=o.indexOf(n),a=s>=0?s+n.length:-1;if(-1===s){var u;let e=(u=n.length)<=2?0:u<=5?1:u<=10?2:u<=20?3:5,t={distance:1/0,end:-1,start:-1};for(let l=0;l<=o.length-n.length;l++)for(let i=-e;i<=e;i++){let r=n.length+i;if(r<=0||l+r>o.length)continue;let s=(0,k.I)(o.slice(l,l+r),n);s<=e&&s<t.distance&&(t={distance:s,end:l+r,start:l})}-1!==t.start&&(s=t.start,a=t.end)}if(-1===s)for(let e=n.length-1;e>0;e--){let t=n.slice(0,Math.max(0,e)),l=o.indexOf(t);if(-1!==l){s=l,a=l+e;break}}if(-1===s)return null;let d=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!t){for(let t of r)if(e===t.offset)return{offset:0,path:t.path}}for(let t of r){let n=t.offset+t.text.length;if(e>=t.offset&&e<=n)return{offset:e-t.offset,path:t.path}}let n=r.at(-1);return n?{offset:n.text.length,path:n.path}:{offset:0,path:i}};return{anchor:d(s,!1),focus:d(a,!0)}}({block:r,findText:c.lZ.string(t)});s&&o.push(s)}),0!==o.length){if(o.length>1){let e=o[0],t=o.at(-1);return{anchor:e.anchor,focus:t.focus}}if(1===o.length)return o[0]}},T=e=>{e.getApi(b.I).suggestion.nodes({transient:!0}).forEach(t=>{let[n]=t,l=e.getApi(b.I).suggestion.suggestionData(n);l&&(0,p.i)(e,{createdAt:new Date(l.createdAt),keyId:(0,p.b)(l.id),suggestionId:l.id,type:l.type,userId:l.userId})}),e.tf.unsetNodes([(0,p._)()],{at:[],mode:"all",match:e=>!!e[(0,p._)()]})},E=e=>{let t=e.getOption(Z,"mode");if("insert"===t){let{tf:t}=(0,y.nB)(e,N),n=e.getApi({key:u.t.ai}),l=n.aiChat.node({at:[],reverse:!0})[1];(0,a.r)(e,()=>{t.ai.removeMarks(),e.getTransforms(Z).aiChat.removeAnchor()}),n.aiChat.hide(),e.tf.focus();let i=e.api.end(l);e.tf.setSelection({anchor:i,focus:i})}"chat"===t&&((0,a.r)(e,()=>{T(e)}),e.getApi(Z).aiChat.hide())},C=(e,t)=>{var n,l;null==(l=e.getApi({key:u.t.cursorOverlay}))||null==(n=l.cursorOverlay)||n.removeCursor("selection");let{chatNodes:i}=e.getOptions(Z);if(i.length>1){let n=t=>{e.setOption(Z,"_replaceIds",t)};0===e.getOption(Z,"_replaceIds").length&&n(i.map(e=>e.id));let l=$(e,t),r=Array.from(e.api.nodes({at:[],match:t=>c.$7.isElement(t)&&e.getOption(Z,"_replaceIds").includes(t.id)}));r.forEach((t,n)=>{var i,o;let[s,a]=t,c=l[n],u=(0,p.A)(e,s)===(0,p.A)(e,c),d=(null==(i=s.suggestion)?void 0:i.type)===(null==(o=c.suggestion)?void 0:o.type);n===r.length-1&&l.length>r.length&&e.tf.replaceNodes(l.slice(n),{at:a}),u&&d&&s.id===c.id||e.tf.replaceNodes(c,{at:a})}),e.getApi(x.vO).blockSelection.set(l.map(e=>e.id)),n(l.map(e=>e.id))}else{let n=$(e,t);e.tf.insertFragment(n);let l=Array.from(e.api.nodes({at:[],mode:"lowest",match:e=>c.Qg.isText(e)&&!!e[(0,p._)()]})),i=e.api.nodesRange(l);e.tf.setSelection(i);return}},w=e=>e.map(e=>c.Qg.isText(e)?(0,i._)((0,l._)({},e),{[(0,p._)()]:!0}):(0,i._)((0,l._)({},e),{children:w(e.children),[(0,p._)()]:!0})),B=e=>e.map(e=>{if(c.Qg.isText(e))return e[u.t.suggestion]||e[u.t.comment]?{text:e.text}:e;if(c.$7.isElement(e)){if(e[u.t.suggestion]){let t={};return Object.keys(e).forEach(n=>{n===u.t.suggestion||n.startsWith(u.t.suggestion)||(t[n]=e[n])}),(0,i._)((0,l._)({},t),{children:B(e.children)})}return(0,i._)((0,l._)({},e),{children:B(e.children)})}return e}),$=(e,t)=>{let n,r,o=B(e.getOption(Z,"chatNodes"));(e=>{if(1!==e.length)return!1;let t=e[0];if(t.type!==u.t.table)return!1;let n=t.children;if(1!==n.length)return!1;let l=n[0];if(l.type!==u.t.tr)return!1;let i=l.children;return 1===i.length&&i[0].type===u.t.td})(o)&&(o=o[0].children[0].children[0].children);let s=(n=(0,m.$r)(e,t),r=o,n.map((e,t)=>{if(!c.$7.isElement(e))return e;let n=null==r?void 0:r[t];return(0,i._)((0,l._)({},e,null!=n?n:{id:(0,d.Ak)()}),{children:e.children})}));return w((0,p.t)(e,o,s,{ignoreProps:["id","listStart"]}))},I=(e,t)=>{let{content:n,id:l}=t,i=e.api.node({at:[],match:e=>c.$7.isElement(e)&&e.id===l});if(!i)return void console.warn('Table cell with id "'.concat(l,'" not found'));let[r,o]=i,s=w((0,p.t)(e,B(r.children),(0,m.$r)(e,n),{ignoreProps:["id"]}));e.tf.replaceNodes(s,{at:o,children:!0})};function W(){let e,t=(0,s.c)(2),n=(0,_.c)(2),l=(0,y.gO)(Z,"toolName"),i=(0,y.gO)(Z,"chat");if("comment"!==l){if(n[0]!==i.messages){let l;if(t[0]!==i.messages){var r;l=null==(r=i.messages)?void 0:r.findLast(P),t[0]=i.messages,t[1]=l}else l=t[1];e=l,n[0]=i.messages,n[1]=e}else e=n[1];return e}}function P(e){return"assistant"===e.role}let D=function(e){var t;let{undo:n=!0}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{api:l,getOptions:i,setOptions:r}=(0,y.nB)(e,{key:u.t.aiChat});l.aiChat.stop();let o=i().chat;o.messages&&o.messages.length>0&&(null==(t=o.setMessages)||t.call(o,[])),r({_replaceIds:[],chatNodes:[],mode:"insert",toolName:null}),n&&e.getTransforms(N).ai.undo()},H=function(e,t){var n,i;let r,{mode:o,options:s,prompt:c,toolName:d}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},{getOptions:g,setOption:h}=(0,y.nB)(e,{key:u.t.aiChat}),{chat:p,toolName:m}=g(),v=null!=(n=null!=d?d:m)?n:null;if(!c&&(null==t?void 0:t.length)===0)return;c||(c=t),o||(o=(0,f.t)(e)?"chat":"insert"),"insert"===o&&e.getTransforms(N).ai.undo(),h("mode",o),h("toolName",v);let k=e.getApi(x.vO).blockSelection.getNodes(),b=e.api.nodesRange(k),_=(0,a.t)(e,{prompt:c}),S=k.length>0?b:e.selection;if(k.length>0)r=k.map(e=>e[0]);else{let t=e.api.blocks({mode:"highest"});r=t.length>1?t.map(e=>e[0]):e.api.fragment()}h("chatNodes",r),h("chatSelection",k.length>0?null:e.selection);let O={children:e.children,selection:null!=S?S:null,toolName:v};null==(i=p.sendMessage)||i.call(p,{text:_},(0,l._)({body:{ctx:O}},s))},L=e=>{let{blocks:t,format:n,sourceBlock:r}=e;if("none"===n)return v(t);let[o]=r,s=c.lZ.firstText(o);if(!s)return null;let a=c.lZ.extractProps(o),u=c.lZ.extractProps(s[0]),d=e=>c.Qg.isText(e)?(0,l._)({},u,e):e.children?(0,i._)((0,l._)({},e),{children:e.children.map(d)}):e;return t.map((e,t)=>"single"===n&&t>0?e:d((0,l._)({},e,a)))},z=function(e,t){let{format:n="single"}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!t||t.api.isEmpty())return;let l=e.getOption(x.vO,"isSelectingSome");if(e.getApi({key:u.t.ai}).aiChat.hide(),!l){let l=e.api.node({block:!0,mode:"lowest"});if(l&&e.api.isSelected(l[1],{contains:!0})&&"none"!==n){let i=L({blocks:v(t.children),format:n,sourceBlock:l});if(!i)return;l[0].type===u.t.codeLine&&t.children[0].type===u.t.codeBlock&&1===t.children.length?e.tf.insertFragment(i[0].children):e.tf.insertFragment(i),e.tf.focus();return}e.tf.insertFragment(t.children),e.tf.focus();return}let i=e.getApi(x.vO).blockSelection.getNodes();if(0===i.length)return;if("none"===n||"single"===n&&i.length>1){e.tf.withoutNormalizing(()=>{(0,x.Lf)(e),e.tf.withNewBatch(()=>{e.getTransforms(x.vO).blockSelection.insertBlocksAndSelect(v(t.children),{at:i[0][1]})})}),e.getApi(x.vO).blockSelection.focus();return}let[,r]=i[0],o=L({blocks:v(t.children),format:n,sourceBlock:i[0]});o&&(e.tf.withoutNormalizing(()=>{(0,x.Lf)(e),e.tf.withNewBatch(()=>{e.getTransforms(x.vO).blockSelection.insertBlocksAndSelect(o,{at:r})})}),e.getApi(x.vO).blockSelection.focus())},M=function(e,t){let{format:n="single"}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},{toolName:l}=e.getOptions(Z);if("generate"===l)return Q(e,t,{format:n});let i=e.getApi(x.vO).blockSelection.getNodes(),r=e.getOptions(x.vO).selectedIds;e.getTransforms(N).ai.undo();let o=e.getTransforms(x.vO).blockSelection.insertBlocksAndSelect;if(!r||0===r.size)return;let s=i.at(-1);if(!s)return;let u=c.s2.next(s[1]);o(i.map(e=>e[0]),{at:u,insertedCallback:()=>{(0,a.r)(e,()=>{T(e)})}}),e.getApi(Z).aiChat.hide({focus:!1})},Q=function(e,t){let{format:n="single"}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!t||t.api.isEmpty())return;let l=e.getOption(x.vO,"isSelectingSome");e.getApi({key:u.t.ai}).aiChat.hide();let i=e.getTransforms(x.vO).blockSelection.insertBlocksAndSelect;if(l){let l=e.getApi(x.vO).blockSelection.getNodes(),r=e.getOptions(x.vO).selectedIds;if(!r||0===r.size)return;let o=l.at(-1);if(!o)return;let s=c.s2.next(o[1]);if("none"===n)return void i(v(t.children),{at:s});let a=L({blocks:v(t.children),format:n,sourceBlock:o});if(!a)return;i(a,{at:s})}else{let[,l]=c.Cb.edges(e.selection),r=[l.path[0]],o=e.api.node({at:r,block:!0,mode:"lowest"});if(!o)return;if("none"===n)return void i(v(t.children),{at:c.s2.next(r)});let s=L({blocks:v(t.children),format:n,sourceBlock:o});if(!s)return;i(s,{at:c.s2.next(r)})}},j=(e,t)=>{e.tf.withoutSaving(()=>{e.tf.removeNodes((0,l._)({at:[],match:t=>c.$7.isElement(t)&&t.type===(0,g.Ht)(e,u.t.aiChat)},t))})},Z=(0,y.e3)({key:u.t.aiChat,dependencies:["ai"],node:{isElement:!0},options:{_blockChunks:"",_blockPath:null,_mdxName:null,_replaceIds:[],aiEditor:null,chat:{messages:[]},chatNodes:[],chatSelection:null,experimental_lastTextId:null,mode:"insert",open:!1,streaming:!1,toolName:null,trigger:" ",triggerPreviousCharPattern:/^\s?$/}}).overrideEditor(e=>{let{api:t,editor:n,getOptions:l,tf:{insertText:i,normalizeNode:r},type:o}=e,s=n.getTransforms(N);return{transforms:{insertText(e,r){let{triggerPreviousCharPattern:o,triggerQuery:s}=l();if(!(()=>{if(!n.selection||!(e=>{let{trigger:t}=l();return t instanceof RegExp?t.test(e):Array.isArray(t)?t.includes(e):e===t})(e)||s&&!s(n))return;let i=n.api.string(n.api.range("before",n.selection));if(!(null==o?void 0:o.test(i)))return;let r=n.api.block({highest:!0});if(r&&n.api.isEmpty(r[0]))return t.aiChat.show(),!0})())return i(e,r)},normalizeNode(e){let[t,i]=e;return t[u.t.ai]&&!l().open?void s.ai.removeMarks({at:i}):c.$7.isElement(t)&&t.type===o&&!l().open?void n.getTransforms(Z).aiChat.removeAnchor({at:i}):r(e)}}}}).extendApi(e=>{let{editor:t,getOption:n,getOptions:i,setOption:o,type:s}=e;return{reset:(0,h.gv)(D,t),submit:(0,h.gv)(H,t),node:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{anchor:i=!1,streaming:o=!1}=e,a=(0,r._)(e,["anchor","streaming"]);if(i)return t.api.node((0,l._)({at:[],match:e=>c.$7.isElement(e)&&e.type===s},a));if(o){if(!n("streaming"))return;let e=n("_blockPath");if(!e)return;return t.api.node((0,l._)({at:e,mode:"lowest",reverse:!0,match:e=>!!e[(0,g.Ht)(t,u.t.ai)]},a))}return t.api.node((0,l._)({match:e=>e[(0,g.Ht)(t,u.t.ai)]},a))},reload:()=>{var e;let{chat:l,chatNodes:r,chatSelection:o}=i();t.getTransforms(N).ai.undo(),o?t.tf.setSelection(o):t.getApi(x.vO).blockSelection.set(r.map(e=>e.id));let s=t.getApi(x.vO).blockSelection.getNodes(),a=s.length>0?t.api.nodesRange(s):t.selection,c={children:t.children,selection:null!=a?a:null,toolName:n("toolName")};null==(e=l.regenerate)||e.call(l,{body:{ctx:c}})},stop:()=>{var e,t;o("streaming",!1),null==(e=(t=i().chat).stop)||e.call(t)}}}).extendApi(e=>{let{api:t,editor:n,getOptions:l,setOption:i,tf:r}=e;return{hide:function(){let{focus:e=!0,undo:l=!0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t.aiChat.reset({undo:l}),i("open",!1),e&&(n.getOption(x.vO,"isSelectingSome")?n.getApi(x.vO).blockSelection.focus():n.tf.focus());let o=n.history.undos.at(-1);(null==o?void 0:o.ai)&&(o.ai=void 0),r.aiChat.removeAnchor()},show:()=>{var e,n;t.aiChat.reset(),i("toolName",null),null==(e=(n=l().chat).setMessages)||e.call(n,[]),i("open",!0)}}}).extendTransforms(e=>{let{editor:t}=e;return{accept:(0,h.gv)(E,t),insertBelow:(0,h.gv)(M,t),removeAnchor:(0,h.gv)(j,t),replaceSelection:(0,h.gv)(z,t)}}),R=function(e,t){let{parser:n}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},{setOption:l}=(0,y.CF)(Z),i=(0,S.useMemo)(()=>e.getApi(m.LK).markdown.deserialize(t,{memoize:!0,parser:n}),[t]);return e.children=i,(0,S.useEffect)(()=>{l("aiEditor",e)},[e,l]),i},q=e=>{var t,n;let l,i,r,o,a,c=(0,s.c)(12),{onChunk:d,onFinish:g}=e;c[0]===Symbol.for("react.memo_cache_sentinel")?(l={key:u.t.aiChat},c[0]=l):l=c[0];let{status:h}=(0,y.gO)(l,"chat"),p="streaming"===h||"submitted"===h,f=null==(n=W())||null==(t=n.parts.find(em))?void 0:t.text,m=(0,S.useRef)(""),v=(0,S.useRef)(p);c[1]!==f||c[2]!==p||c[3]!==g?(i=()=>{p||(m.current=""),v.current&&!p&&(null==g||g({content:null!=f?f:""})),v.current=p},c[1]=f,c[2]=p,c[3]=g,c[4]=i):i=c[4],c[5]!==p?(r=[p],c[5]=p,c[6]=r):r=c[6],(0,S.useEffect)(i,r),c[7]!==f||c[8]!==d?(o=()=>{if(!f)return;let e=f.slice(m.current.length),t=[];if(e){let n=""===m.current;t.push({text:e}),d({chunk:e,isFirst:n,nodes:t,text:f})}m.current=f},c[7]=f,c[8]=d,c[9]=o):o=c[9],c[10]!==f?(a=[f],c[10]=f,c[11]=a):a=c[11],(0,S.useEffect)(o,a)},K=e=>{let t,n,l=(0,s.c)(9),{onOpenBlockSelection:i,onOpenChange:r,onOpenCursor:o,onOpenSelection:a}=e,{editor:c}=(0,y.CF)(Z),u=(0,y.gO)(Z,"open");l[0]!==c||l[1]!==i||l[2]!==r||l[3]!==o||l[4]!==a||l[5]!==u?(t=()=>{if(null==r||r(u),u){if(i){let e=c.getApi(x.vO).blockSelection;if(c.getOption(x.vO,"isSelectingSome"))return void i(e.getNodes())}if(o&&c.api.isCollapsed())return void o();if(a&&c.api.isExpanded())return void a()}},l[0]=c,l[1]=i,l[2]=r,l[3]=o,l[4]=a,l[5]=u,l[6]=t):t=l[6],l[7]!==u?(n=[u],l[7]=u,l[8]=n):n=l[8],(0,S.useEffect)(t,n)},G=function(e){let{direction:t="right"}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n="right"===t?e.trimEnd():e.trimStart();return"right"===t?e.slice(n.length):e.slice(0,e.length-n.length)};function J(e){let t=e.trim(),n=t.startsWith("$$"),l=t.endsWith("$$");return n&&l}let V="listStyleType",U=(e,t,n)=>t.map(t=>c.$7.isElement(t)?(0,i._)((0,l._)({},((e,t)=>{if(t.listStyleType&&t.listStart){var n,r;let o=null==(n=e.api.previous({at:null==(r=e.selection)?void 0:r.focus}))?void 0:n[0];return(null==o?void 0:o.listStyleType)&&(null==o?void 0:o.listStart)||1===t.listStart?t:(0,i._)((0,l._)({},t),{listRestartPolite:t.listStart})}return t})(e,t),n.elementProps),{children:U(e,t.children,n)}):(0,i._)((0,l._)({},n.textProps,t),{text:t.text})),X=RegExp("<([A-Za-z][A-Za-z0-9._:-]*)(?:\\s[^>]*?)?(?<!\\/)>"),Y=(e,t,n)=>{let r,o=(r=t,!t.startsWith("$$")||t.startsWith("$$\n")||J(t)||(r=t.replace("$$",String.raw(A()))),r),s=ee(e,o);if(Array.isArray(s))return s;let a=[];a=e.getApi(m.LK).markdown.deserialize(o,(0,i._)((0,l._)({},n),{preserveEmptyParagraphs:!1}));let d=G(t),g=a.at(-1),h="\n\n"===d,p="\n\n"===G(t,{direction:"left"}),f=(null==g?void 0:g.type)==="code_block"||(null==g?void 0:g.type)==="table",v=a;if(g&&!f&&d.length>0&&!h){let e=[{text:d}],t=g.children.at(-1);if(t&&c.Qg.isText(t)&&1===Object.keys(t).length){g.children.pop();let e=[{text:t.text+d}];g.children.push(...e)}else g.children.push(...e);v=[...a.slice(0,-1),g]}return h&&!f&&v.push({children:[{text:""}],type:u.t.p}),p&&!f&&v.unshift({children:[{text:""}],type:u.t.p}),v},ee=(e,t)=>{var n;let l=e.getOption(Z,"_mdxName");if(l)return t.includes("</".concat(l,">"))?(e.setOption(Z,"_mdxName",null),!1):[{children:[{text:t}],type:(0,g.Ht)(e,u.t.p)}];let i=null==(n=X.exec(t))?void 0:n[1];t.startsWith("<".concat(i))&&e.setOption(Z,"_mdxName",null!=i?i:null)},et=(e,t,n)=>{let o,s,a,{value:d}=t,h=(0,r._)(t,["value"]),{value:p}=((e,t)=>{var n;let r=new Set([u.t.h1,u.t.h2,u.t.h3,u.t.h4,u.t.h5,u.t.h6]),o=t.at(-1);if(o&&r.has(null!=(n=(0,g.Bt)(e,o.type))?n:o.type)&&c.$7.isElement(o)){let e=o.children.at(-1);if(c.Qg.isText(e)){let n=G(null==e?void 0:e.text),r=[...o.children.slice(0,-1),{text:e.text.trimEnd()}],s=(0,i._)((0,l._)({},o),{children:r});return{trimmedText:n,value:[...t.slice(0,-1),s]}}}return{trimmedText:"",value:t}})(e,null!=d?d:e.children),f="";f=e.getApi(m.LK).markdown.serialize((0,l._)({value:p},h));let v=G(n);return s=(o=f.trim()).startsWith("```"),a=o.endsWith("```"),s&&a&&!n.endsWith("```")&&(f=f.trimEnd().slice(0,-3)+v),J(f)&&!n.endsWith("$$")&&(f=f.trimEnd().slice(0,-3)+v),f=(f=(f=f.replace(/&#x20;/g," ")).replace(/&#x200B;/g," ")).replace(/\u200B/g,""),"\n\n"!==v&&(f=f.trimEnd()+v),n.endsWith("\n\n")&&("\n"===f?f="":f.endsWith("\n\n")&&(f=f.slice(0,-1))),f=f.replace(/\\([\\`*_{}\\[\]()#+\-\\.!~<>|$])/g,"$1")},en=(e,t)=>{let n=e;for(let e=0;e<t;e++)n=c.s2.next(n);return n};function el(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},{_blockChunks:l,_blockPath:i}=e.getOptions(Z);if(null===i){let l=Y(e,t),i=ei(e),r=e.api.node(i)[0],o=0===c.lZ.string(r).length&&r.type===(0,g.Ht)(e,u.t.p);if(o&&e.tf.removeNodes({at:i}),l.length>0&&(e.tf.insertNodes(U(e,[l[0]],n),{at:i,nextBlock:!o,select:!0}),e.setOption(Z,"_blockPath",ei(e)),e.setOption(Z,"_blockChunks",t),l.length>1)){let i=l.slice(1),r=ei(e);e.tf.insertNodes(U(e,i,n),{at:r,nextBlock:!0,select:!0});let o=e.api.node(en(r,i.length));e.setOption(Z,"_blockPath",o[1]);let s=et(e,{value:[o[0]]},t);e.setOption(Z,"_blockChunks",s)}}else{let o=l+t,s=Y(e,o);if(0===s.length)return console.warn("unsupport md nodes: ".concat(JSON.stringify(o)));if(1===s.length){var r;let l=e.api.node(i)[0];if(r=s[0],l.type!==e.getType(u.t.p)||r.type!==e.getType(u.t.p)?l.type===r.type:(0,h.O9)(l[V])||(0,h.O9)(r[V])?l[V]===r[V]:l.type===r.type){let l,r=e.getApi(m.LK).markdown.deserializeInline(t,l);e.tf.insertNodes(U(e,r,n),{at:e.api.end(i),select:!0});let a=et(e,{value:[e.api.node(i)[0]]},o),d=c.lZ.string(s[0]);if(a===o&&d===a)e.setOption(Z,"_blockChunks",o);else{e.tf.replaceNodes(U(e,[s[0]],n),{at:i,select:!0});let t=et(e,{value:[s[0]]},o);e.setOption(Z,"_blockChunks",s[0].type===(0,g.Ht)(e,u.t.codeBlock)||s[0].type===(0,g.Ht)(e,u.t.table)||s[0].type===(0,g.Ht)(e,u.t.equation)?o:t)}}else{let t=et(e,{value:[s[0]]},o);e.tf.replaceNodes(U(e,[s[0]],n),{at:i,select:!0}),e.setOption(Z,"_blockChunks",t)}}else if(e.tf.replaceNodes(U(e,[s[0]],n),{at:i,select:!0}),s.length>1){let t=en(i,s.length-1);e.tf.insertNodes(U(e,s.slice(1),n),{at:c.s2.next(i),select:!0}),e.setOption(Z,"_blockPath",t);let l=e.api.node(t)[0],r=et(e,{value:[l]},o);e.setOption(Z,"_blockChunks",r)}}}let ei=e=>{var t,n,l,i,r;let o=null!=(t=null!=(n=(e=>{let t=e.getApi(Z).aiChat.node({anchor:!0});if(t)return c.s2.previous(t[1])})(e))?n:null==(r=e.selection)?void 0:r.focus.path.slice(0,1))?t:[0],s=e.api.node(o);return s&&(s[0].type===(0,g.Ht)(e,u.t.columnGroup)||s[0].type===(0,g.Ht)(e,u.t.table))&&null!=(l=null==(i=e.api.above())?void 0:i[1])?l:o},er=e=>{let{suggestionText:t}=e.getOptions({key:u.t.copilot});if(!(null==t?void 0:t.length))return!1;e.tf.insertFragment((0,m.wD)(e,t))};async function eo(e){let{api:t="/api/completion",body:n,credentials:i,fetch:r=fetch,headers:o,prompt:s,setAbortController:a=()=>{},setCompletion:c=()=>{},setError:u=()=>{},setLoading:d=()=>{},onError:g,onFinish:h,onResponse:p}=e;try{d(!0),u(null);let e=new AbortController;a(e),c("");let g=await r(t,{body:JSON.stringify((0,l._)({prompt:s},n)),credentials:i,headers:(0,l._)({"Content-Type":"application/json"},o),method:"POST",signal:e.signal}).catch(e=>{throw e});if(p&&await p(g),!g.ok)throw Error(await g.text()||"Failed to fetch the chat response.");if(!g.body)throw Error("The response body is empty.");let{text:f}=await g.json();if(!f)throw Error("The response does not contain a text field.");return c(f),h&&h(s,f),a(null),f}catch(e){if("AbortError"===e.name)return a(null),null;e instanceof Error&&g&&g(e),u(e)}finally{d(!1)}}let es=/^\s*(\S)/,ea=/[\u1100-\u11FF\u3040-\u30FF\u3400-\u4DBF\u4E00-\u9FFF\uAC00-\uD7AF\uF900-\uFAFF]/,ec=/^(\s*)([\u1100-\u11FF\u3040-\u30FF\u3400-\u4DBF\u4E00-\u9FFF\uAC00-\uD7AF\uF900-\uFAFF])([\u3000-\u303F\uFF00-\uFFEF])?/,eu=/^(\s*\S+?)(?=[\s\u1100-\u11FF\u3040-\u30FF\u3400-\u4DBF\u4E00-\u9FFF\uAC00-\uD7AF\uF900-\uFAFF]|$)/,ed=async e=>{var t;let{api:n,getOptions:r,setOption:o}=(0,y.nB)(e,{key:u.t.copilot}),{completeOptions:s,getPrompt:a,isLoading:c,triggerQuery:d}=r();if(c||(null==(t=e.getOptions({key:u.t.aiChat}).chat)?void 0:t.isLoading)||!d({editor:e}))return!1;let g=a({editor:e});if(0===g.length)return!1;n.copilot.stop(),await eo((0,i._)((0,l._)({prompt:g,onFinish:(e,t)=>{n.copilot.setBlockSuggestion({text:t})}},s),{setAbortController:e=>o("abortController",e),setCompletion:e=>o("completion",e),setError:e=>o("error",e),setLoading:e=>o("isLoading",e),onError:e=>{var t;o("error",e),null==s||null==(t=s.onError)||t.call(s,e)}}))},eg=(e,t)=>{e.setOption(ef,"shouldAbort",!1),t(),e.setOption(ef,"shouldAbort",!0)},eh=e=>{let{api:t,getOptions:n}=(0,y.nB)(e,{key:u.t.copilot}),{getNextWord:l,suggestionText:i}=n();if(!(null==i?void 0:i.length))return!1;let{firstWord:r,remainingText:o}=l({text:i});t.copilot.setBlockSuggestion({text:o}),eg(e,()=>{e.tf.insertFragment((0,m.wD)(e,r))})},ep=(e,t)=>{let n="";for(let l of t)if("insert_node"===l.type){let t=l.node;n+=(0,m.D1)(e,{value:[t]})}else"insert_text"===l.type&&(n+=l.text);return n},ef=(0,y.e3)({key:u.t.copilot,handlers:{onBlur:e=>{let{api:t}=e;t.copilot.reject()},onMouseDown:e=>{let{api:t}=e;t.copilot.reject()}},options:{abortController:null,completeOptions:{},completion:"",debounceDelay:0,error:null,getNextWord:e=>{let t,n,{text:l}=e;if(!l)return{firstWord:"",remainingText:""};let i=es.exec(l);if(!i)return{firstWord:"",remainingText:""};let r=i[1];if(ea.test(r)){let e=ec.exec(l);if(e){let[,i="",r="",o=""]=e;t=i+r+o,n=l.slice(t.length)}else t="",n=l}else{let e=eu.exec(l);e?(t=e[0],n=l.slice(t.length)):(t=l,n="")}return{firstWord:t,remainingText:n}},isLoading:!1,renderGhostText:null,shouldAbort:!0,suggestionNodeId:null,suggestionText:null,autoTriggerQuery:e=>{let{editor:t}=e;if(t.getOptions({key:u.t.copilot}).suggestionText||t.api.isEmpty(t.selection,{block:!0}))return!1;let n=t.api.block();return!!n&&" "===c.lZ.string(n[0]).at(-1)},getPrompt:e=>{let{editor:t}=e,n=t.api.block({highest:!0});return n?(0,m.g$)(t,{value:[n[0]]}):""},triggerQuery:e=>{let{editor:t}=e;return!t.api.isExpanded()&&!!t.api.isAt({end:!0})}}}).overrideEditor(e=>{let{api:t,editor:n,getOptions:l,setOption:i,tf:{apply:r,insertText:o,redo:s,setSelection:a,undo:u,writeHistory:d}}=e,g=null;return{transforms:{apply(e){let{shouldAbort:n}=l();n&&t.copilot.reject(),r(e)},insertText(e,t){let r=l().suggestionText;(null==r?void 0:r.startsWith(e))?eg(n,()=>{n.tf.withoutMerging(()=>{i("suggestionText",null==r?void 0:r.slice(e.length)),o(e)})}):o(e,t)},redo(){if(!l().suggestionText)return s();let e=n.history.redos.at(-1),t=l().suggestionText;return e&&!1===e.shouldAbort&&t?void eg(n,()=>{let l=ep(n,e.operations);i("suggestionText",t.slice(l.length)),s()}):s()},setSelection(e){a(e),n.selection&&(!g||!c.Cb.equals(g,n.selection))&&l().autoTriggerQuery({editor:n})&&n.api.isFocused()&&t.copilot.triggerSuggestion(),g=n.selection},undo(){if(!l().suggestionText)return u();let e=n.history.undos.at(-1),t=l().suggestionText;return e&&!1===e.shouldAbort&&t?void eg(n,()=>{i("suggestionText",ep(n,e.operations)+t),u()}):u()},writeHistory:(e,t)=>(l().isLoading||(t.shouldAbort=l().shouldAbort),d(e,t))}}}).extendSelectors(e=>{let{getOptions:t}=e;return{isSuggested:e=>t().suggestionNodeId===e}}).extendTransforms(e=>{let{editor:t}=e;return{accept:(0,h.gv)(er,t),acceptNextWord:(0,h.gv)(eh,t)}}).extendApi(e=>{let{api:t,editor:n,getOptions:l,setOption:i,setOptions:r}=e,o=l().debounceDelay,s=(0,h.gv)(ed,n);return o&&(s=O((0,h.gv)(ed,n),o)),{triggerSuggestion:s,setBlockSuggestion:e=>{let{id:t=l().suggestionNodeId,text:i}=e;t||(t=n.api.block()[0].id),r({suggestionNodeId:t,suggestionText:i})},stop:()=>{var e;let{abortController:n}=l();null==(e=t.copilot.triggerSuggestion)||e.cancel(),n&&(n.abort(),i("abortController",null))}}}).extendApi(e=>{let{api:t,getOptions:n,setOptions:l}=e;return{reject:()=>{var e;if(!(null==(e=n().suggestionText)?void 0:e.length))return!1;t.copilot.stop(),l({completion:null,suggestionNodeId:null,suggestionText:null})}}}).extend({render:{belowNodes:e=>{let{editor:t}=e,{renderGhostText:n}=(0,y.nB)(t,{key:u.t.copilot}).getOptions();if(n)return e=>{let{children:t}=e;return S.createElement(S.Fragment,null,t,S.createElement(n,null))}}},shortcuts:{accept:{keys:"tab"},reject:{keys:"escape"}}});function em(e){return"text"===e.type}},50250:(e,t,n)=>{n.d(t,{n:()=>m,r:()=>f,t:()=>v});var l=n(99019),i=n(5147),r=n(50357),o=n(48674),s=n(14796),a=n(2498),c=n(42697),u=n(87010);let d=function(e,t){var n;let{target:r}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!r&&!(null==(n=e.selection)?void 0:n.focus.path))return;let o=t.map(e=>(0,i._)((0,l._)({},e),{ai:!0}));e.tf.withoutNormalizing(()=>{e.tf.insertNodes(o,{at:e.api.end(r||e.selection.focus.path),select:!0}),e.tf.collapse({edge:"end"})})},g=function(e){let{at:t=[]}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=(0,r.Ht)(e,o.t.ai);e.tf.unsetNodes(n,{at:t,match:e=>e[n]})},h=function(e){let{at:t=[]}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e.tf.removeNodes({at:t,match:e=>s.Qg.isText(e)&&!!e.ai})},p=e=>{var t;let n=e.api.some({at:[],match:e=>!!e.ai})||e.api.some({at:[],match:e=>!!e[(0,c._)()]});(null==(t=e.history.undos.at(-1))?void 0:t.ai)&&n&&(e.undo(),e.history.redos.pop())},f=function(e,t){var n;let{split:l}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};l?e.tf.withNewBatch(t):e.tf.withMerging(t);let i=null==(n=e.history.undos)?void 0:n.at(-1);i&&(i.ai=!0)},m=(0,r.qt)({key:o.t.ai,node:{isDecoration:!1,isLeaf:!0}}).extendTransforms(e=>{let{editor:t}=e;return{insertNodes:(0,a.gv)(d,t),removeMarks:(0,a.gv)(g,t),removeNodes:(0,a.gv)(h,t),undo:(0,a.gv)(p,t)}}),v=(e,t)=>{let{prompt:n=""}=t,l={editor:e,isBlockSelecting:e.getOption({key:o.t.blockSelection},"isSelectingSome"),isSelecting:(0,u.t)(e)};return"function"==typeof n?n(l):"object"==typeof n?((e,t)=>{var n,l;let{isBlockSelecting:i,isSelecting:r}=t;return i&&e.blockSelecting?null!=(n=e.blockSelecting)?n:e.default:r&&e.selecting&&null!=(l=e.selecting)?l:e.default})(n,l):n}},54097:(e,t,n)=>{n.d(t,{I:()=>i});var l=n(42697);let i=(0,n(28268).HS)(l.a)}}]);