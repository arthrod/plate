{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "import-toolbar-button",
  "type": "registry:ui",
  "title": "Import Toolbar Button",
  "description": "A toolbar button to import editor content from a file.",
  "dependencies": [
    "use-file-picker@2.1.2"
  ],
  "registryDependencies": [
    "dropdown-menu",
    "https://platejs.org/r/toolbar"
  ],
  "files": [
    {
      "path": "src/registry/ui/import-toolbar-button.tsx",
      "content": "'use client';\n\nimport * as React from 'react';\n\nimport type { DropdownMenuProps } from '@radix-ui/react-dropdown-menu';\n\nimport { getCommentKey } from '@platejs/comment';\nimport { importDocxWithTracking } from '@platejs/docx-io';\nimport { MarkdownPlugin } from '@platejs/markdown';\nimport { BaseSuggestionPlugin, getSuggestionKey } from '@platejs/suggestion';\nimport { ArrowUpToLineIcon } from 'lucide-react';\nimport { KEYS, TextApi, type TNode } from 'platejs';\nimport { useEditorRef } from 'platejs/react';\nimport { getEditorDOMFromHtmlString } from 'platejs/static';\nimport { useFilePicker } from 'use-file-picker';\n\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuGroup,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from '@/components/ui/dropdown-menu';\n\nimport { commentPlugin } from '@/registry/components/editor/plugins/comment-kit';\nimport {\n  discussionPlugin,\n  type TDiscussion,\n} from '@/registry/components/editor/plugins/discussion-kit';\nimport { getDiscussionCounterSeed } from '../lib/discussion-ids';\nimport { ToolbarButton } from './toolbar';\n\ntype ImportType = 'html' | 'markdown';\n\n// Regex pattern for splitting author names into initials (top-level for performance)\nconst WHITESPACE_REGEX = /\\s+/;\n\nexport function ImportToolbarButton(props: DropdownMenuProps) {\n  const editor = useEditorRef();\n  const [open, setOpen] = React.useState(false);\n\n  const getFileNodes = (text: string, type: ImportType) => {\n    if (type === 'html') {\n      const editorNode = getEditorDOMFromHtmlString(text);\n      const nodes = editor.api.html.deserialize({\n        element: editorNode,\n      });\n\n      return nodes;\n    }\n\n    if (type === 'markdown') {\n      return editor.getApi(MarkdownPlugin).markdown.deserialize(text);\n    }\n\n    return [];\n  };\n\n  const { openFilePicker: openMdFilePicker } = useFilePicker({\n    accept: ['.md', '.mdx'],\n    multiple: false,\n    onFilesSelected: async ({ plainFiles }) => {\n      const text = await plainFiles[0].text();\n\n      const nodes = getFileNodes(text, 'markdown');\n\n      editor.tf.insertNodes(nodes);\n    },\n  });\n\n  const { openFilePicker: openHtmlFilePicker } = useFilePicker({\n    accept: ['text/html'],\n    multiple: false,\n    onFilesSelected: async ({ plainFiles }) => {\n      const text = await plainFiles[0].text();\n\n      const nodes = getFileNodes(text, 'html');\n\n      editor.tf.insertNodes(nodes);\n    },\n  });\n\n  const { openFilePicker: openDocxFilePicker } = useFilePicker({\n    accept: ['.docx'],\n    multiple: false,\n    onFilesSelected: async ({ plainFiles }) => {\n      const arrayBuffer = await plainFiles[0].arrayBuffer();\n\n      // Compute next discussion number to avoid ID collisions\n      const existingDiscussions =\n        editor.getOption(discussionPlugin, 'discussions') ?? [];\n      let discussionCounter = getDiscussionCounterSeed(existingDiscussions);\n\n      // Import with full tracking support (suggestions + comments)\n      const result = await importDocxWithTracking(editor as any, arrayBuffer, {\n        suggestionKey: KEYS.suggestion,\n        getSuggestionKey,\n        commentKey: KEYS.comment,\n        getCommentKey,\n        isText: TextApi.isText,\n        generateId: () => `discussion${++discussionCounter}`,\n      });\n      console.log('[DOCX DEBUG] import result:', result);\n      console.log(\n        '[DOCX DEBUG] editor.children after import:',\n        JSON.stringify(editor.children, null, 2)\n      );\n\n      // Diagnostic: iterate over all nodes to find suggestion marks\n      for (const [node, path] of editor.api.nodes({\n        at: [],\n        mode: 'all',\n      })) {\n        const nodeRecord = node as TNode & { suggestion?: boolean };\n        if (nodeRecord.suggestion) {\n          console.log(\n            '[DIAG] suggestion node:',\n            JSON.stringify(node),\n            'path:',\n            path\n          );\n          const dataList = editor\n            .getApi(BaseSuggestionPlugin)\n            .suggestion.dataList(nodeRecord as any);\n          console.log('[DIAG] dataList:', dataList);\n        }\n      }\n\n      // Diagnostic: Log result summary\n      console.log('[DOCX DIAG] Result summary:', {\n        insertions: result.insertions,\n        deletions: result.deletions,\n        comments: result.comments,\n        discussionCount: result.discussions.length,\n        errors: result.errors,\n        hasTracking: result.hasTracking,\n      });\n\n      // Diagnostic: Inspect what marks are actually on nodes after a delay\n      setTimeout(() => {\n        const allText = Array.from(\n          editor.api.nodes({ at: [], mode: 'all', match: TextApi.isText })\n        ) as [TNode & { text?: string; [key: string]: unknown }, number[]][];\n        for (const [node, path] of allText) {\n          const textNode = node as TNode & {\n            text?: string;\n            [key: string]: unknown;\n          };\n          const hasSuggestion = textNode[KEYS.suggestion];\n          const hasComment = textNode[KEYS.comment];\n          if (hasSuggestion || hasComment) {\n            console.log('[DOCX DIAG] annotated node:', {\n              text: textNode.text?.slice(0, 50),\n              path,\n              hasSuggestion,\n              hasComment,\n              keys: Object.keys(textNode).filter((k) => k !== 'text'),\n            });\n          }\n        }\n      }, 100);\n\n      // Add imported discussions to the discussion plugin\n      if (result.discussions.length > 0) {\n        // Convert imported discussions to TDiscussion format\n        const newDiscussions: TDiscussion[] = result.discussions.map((d) => ({\n          id: d.id,\n          comments: (d.comments ?? []).map((c, index) => ({\n            id: `comment${index + 1}`,\n            contentRich:\n              c.contentRich as TDiscussion['comments'][number]['contentRich'],\n            createdAt: c.createdAt ?? new Date(),\n            discussionId: d.id,\n            isEdited: false,\n            userId: c.userId ?? c.user?.id ?? 'imported-unknown',\n            authorName: c.user?.name,\n            authorInitials: c.user?.name\n              ? c.user.name\n                  .split(WHITESPACE_REGEX)\n                  .slice(0, 2)\n                  .map((w) => w[0]?.toUpperCase() ?? '')\n                  .join('')\n              : undefined,\n          })),\n          createdAt: d.createdAt ?? new Date(),\n          documentContent: d.documentContent,\n          isResolved: false,\n          userId: d.userId ?? d.user?.id ?? 'imported-unknown',\n          authorName: d.user?.name,\n          authorInitials: d.user?.name\n            ? d.user.name\n                .split(WHITESPACE_REGEX)\n                .slice(0, 2)\n                .map((w) => w[0]?.toUpperCase() ?? '')\n                .join('')\n            : undefined,\n        }));\n\n        editor.setOption(discussionPlugin, 'discussions', [\n          ...existingDiscussions,\n          ...newDiscussions,\n        ]);\n        editor.setOption(commentPlugin, 'uniquePathMap', new Map());\n      }\n\n      // Log import results\n      if (result.hasTracking) {\n        console.log(\n          `[DOCX Import] Imported ${result.insertions} insertions, ${result.deletions} deletions, ${result.comments} comments`\n        );\n        if (result.errors.length > 0) {\n          console.warn('[DOCX Import] Errors:', result.errors);\n        }\n      }\n    },\n  });\n\n  return (\n    <DropdownMenu open={open} onOpenChange={setOpen} modal={false} {...props}>\n      <DropdownMenuTrigger asChild>\n        <ToolbarButton pressed={open} tooltip=\"Import\" isDropdown>\n          <ArrowUpToLineIcon className=\"size-4\" />\n        </ToolbarButton>\n      </DropdownMenuTrigger>\n\n      <DropdownMenuContent align=\"start\">\n        <DropdownMenuGroup>\n          <DropdownMenuItem\n            onSelect={() => {\n              openHtmlFilePicker();\n            }}\n          >\n            Import from HTML\n          </DropdownMenuItem>\n\n          <DropdownMenuItem\n            onSelect={() => {\n              openMdFilePicker();\n            }}\n          >\n            Import from Markdown\n          </DropdownMenuItem>\n\n          <DropdownMenuItem\n            onSelect={() => {\n              openDocxFilePicker();\n            }}\n          >\n            Import from Word\n          </DropdownMenuItem>\n        </DropdownMenuGroup>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  );\n}\n",
      "type": "registry:ui"
    }
  ],
  "meta": {
    "docs": [
      {
        "route": "/docs/import",
        "title": "Import"
      }
    ],
    "examples": [
      "basic-nodes-demo"
    ],
    "label": "New"
  }
}